<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aether Empires - Floating Island RTS</title>
    <style>
        :root {
            --bg: #0a0a1a;
            --panel: #1a1a2e;
            --accent: #4ecca3;
            --text: #e1e1e1;
            --p1: #ff4d4d; --p2: #4d79ff; --p3: #4dff4d; --p4: #ffff4d;
        }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: var(--text); user-select: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        #top-bar { pointer-events: auto; background: rgba(26, 26, 46, 0.9); padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--accent); position: relative; }
        #instruction-overlay { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 5px; color: var(--accent); font-weight: bold; pointer-events: none; display: none; z-index: 50; border: 1px solid var(--accent); }
        #bottom-panel { pointer-events: auto; background: rgba(26, 26, 46, 0.9); height: 170px; display: flex; padding: 10px; border-top: 2px solid var(--accent); transform: translateY(100%); transition: transform 0.3s; }
        #bottom-panel.visible { transform: translateY(0); }
        .island-info { display: flex; flex-direction: column; width: 250px; border-right: 1px solid #444; margin-right: 15px; overflow-y: auto; }
        .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; flex: 1; }
        button { background: #333; color: white; border: 1px solid var(--accent); padding: 5px 10px; cursor: pointer; transition: 0.2s; font-size: 0.85em; }
        button:hover { background: var(--accent); color: black; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        #game-canvas { display: block; cursor: crosshair; }
        #setup-screen { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .resource-val { font-weight: bold; color: gold; }
        #victory-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; flex-direction: column; align-items: center; justify-content: center; }
        .cost { font-size: 0.75em; color: #aaa; display: block; }
        .bld-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); margin-bottom: 2px; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
    </style>
</head>
<body>
    <div id="setup-screen">
        <h1>AETHER EMPIRES</h1>
        <p>Destroy all enemy Palaces to win.</p>
        <div style="margin: 20px">
            <button onclick="startGame(4)">4 Players (Skirmish)</button>
            <button onclick="startGame(8)">8 Players (War)</button>
            <button onclick="startGame(16)">16 Players (Chaos)</button>
        </div>
    </div>

    <div id="victory-screen">
        <h1 id="win-text">VICTORY</h1>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <div id="instruction-overlay">Select your starting island</div>
    <div id="ui-layer">
        <div id="top-bar">
            <div id="stats">
                Gold: <span id="gold-res" class="resource-val">0</span> | 
                Aeth: <span id="aeth-res" class="resource-val">0</span> | 
                Pop: <span id="pop-res" class="resource-val">0</span> |
                Islands: <span id="island-count">0</span> | 
                Units: <span id="unit-count">0</span>
            </div>
            <div id="game-time">00:00</div>
        </div>

        <div id="bottom-panel">
            <div class="island-info" id="island-details">
                <strong id="island-name">Island</strong>
                <span id="island-owner">Owner: Neutral</span>
                <div id="island-buildings" style="margin: 5px 0;"></div>
                <span id="island-hp">HP: 100/100</span>
                <span id="island-slots">Slots: 0/0</span>
                <span id="island-units" style="color: var(--accent); font-weight: bold;">Units: S:0 C:0</span>
            </div>
            <div class="actions" id="island-actions">
                <button id="btn-mine" onclick="build('mine')">Build Mine <span class="cost">G:50</span></button>
                <button id="btn-farm" onclick="build('farm')">Build Farm <span class="cost">G:30</span></button>
                <button id="btn-windmill" onclick="build('windmill')">Build Windmill <span class="cost">G:60</span></button>
                <button id="btn-barracks" onclick="build('barracks')">Build Barracks <span class="cost">G:100</span></button>
                <button id="btn-research" onclick="build('lab')">Build Lab <span class="cost">G:150</span></button>
                <div style="width: 100%; margin: 0; display: flex; gap: 8px; border-top: 1px solid #444; padding-top: 8px;">
                    <button id="btn-unit-train" onclick="trainUnit('soldier')">Train Soldier <span class="cost">G:20</span></button>
                    <button id="btn-unit-send" onclick="sendUnit('soldier')">Send Soldier</button>
                    <button id="btn-colony-train" onclick="trainUnit('colony')">Train Colony <span class="cost">G:100</span></button>
                    <button id="btn-colony-send" onclick="sendUnit('colony')">Send Colony</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const UI = {
            gold: document.getElementById('gold-res'),
            aeth: document.getElementById('aeth-res'),
            pop: document.getElementById('pop-res'),
            bottom: document.getElementById('bottom-panel'),
            details: document.getElementById('island-details'),
            name: document.getElementById('island-name'),
            owner: document.getElementById('island-owner'),
            hp: document.getElementById('island-hp')
        };

        let gameState = 'setup';
        let players = [];
        let islands = [];
        let units = [];
        let selectedIsland = null;
        let camera = { x: 0, y: 0, zoom: 1 };
        let isDragging = false;
        let lastMouse = { x: 0, y: 0 };
        window.addEventListener('wheel', (e) => {
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            camera.zoom = Math.max(0.1, Math.min(camera.zoom * delta, 5));
        }, { passive: true });
        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                camera.x += (e.clientX - lastMouse.x) / camera.zoom;
                camera.y += (e.clientY - lastMouse.y) / camera.zoom;
                lastMouse = { x: e.clientX, y: e.clientY };
            }
        });
        window.addEventListener('mouseup', () => { isDragging = false; });
        canvas.addEventListener('contextmenu', e => e.preventDefault());
        let lastTime = 0;
        let cycleTimer = 0;
        const CYCLE_DURATION = 90000;
        let myPlayerId = 0;
        let playerCount = 4;

        const COLORS = ['#888', '#ff4d4d', '#4d79ff', '#4dff4d', '#ffff4d', '#ff4dff', '#4dffff', '#ffa500', '#800080', '#008080', '#a52a2a', '#f0e68c', '#d2b48c', '#00ff00', '#0000ff', '#ff0000', '#ffffff'];

        class Island {
            constructor(x, y, size, id) {
                this.id = id; this.x = x; this.y = y; this.size = size;
                this.owner = -1; this.hp = 100; this.maxHp = 100;
                this.buildings = []; this.type = 'neutral';
                this.maxSlots = Math.max(1, Math.floor(size / 8));
                this.usedSlots = 0;
                this.stationedUnits = { soldier: 0, colony: 0 };
            }
            update(dt) {
                // Production handled by cycle timer in game loop
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y);
                ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath();
                ctx.ellipse(5, 15, this.size, this.size * 0.7, 0, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = this.owner === -1 ? '#444' : COLORS[this.owner + 1];
                ctx.beginPath(); ctx.arc(0, 0, this.size, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = selectedIsland === this ? 3 : 1; ctx.stroke();
                this.buildings.forEach((b, i) => {
                    ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fillRect(-this.size + 10 + (i * 10), this.size - 15, 6, 6);
                });
                const totalU = this.stationedUnits.soldier + this.stationedUnits.colony;
                for(let i=0; i < Math.min(totalU, 20); i++) {
                    const ang = (i / Math.min(totalU, 20)) * Math.PI * 2 + (Date.now() / 2000);
                    const dist = this.size + 12; const ux = Math.cos(ang) * dist; const uy = Math.sin(ang) * dist;
                    ctx.fillStyle = i < this.stationedUnits.soldier ? '#fff' : '#ffd700';
                    ctx.beginPath(); ctx.arc(ux, uy, 2.5, 0, Math.PI * 2); ctx.fill();
                }
                if (this.hp < this.maxHp) {
                    ctx.fillStyle = 'red'; ctx.fillRect(-20, -this.size - 10, 40, 4);
                    ctx.fillStyle = 'green'; ctx.fillRect(-20, -this.size - 10, 40 * (this.hp / this.maxHp), 4);
                }
                if (this.type === 'palace') {
                    ctx.fillStyle = 'gold'; ctx.beginPath();
                    ctx.moveTo(0, -10); ctx.lineTo(10, 5); ctx.lineTo(-10, 5); ctx.fill();
                }
                ctx.restore();
            }
        }

        class Unit {
            constructor(playerId, x, y, targetIsland, type = 'soldier') {
                this.playerId = playerId; this.x = x; this.y = y; this.target = targetIsland;
                this.type = type; this.speed = type === 'colony' ? 50 : 80;
                this.damage = type === 'soldier' ? 10 : 0; this.hp = 20; this.dead = false;
            }
            update(dt) {
                const dx = this.target.x - this.x; const dy = this.target.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 5) { this.arrive(); } else {
                    this.x += (dx / dist) * this.speed * (dt / 1000);
                    this.y += (dy / dist) * this.speed * (dt / 1000);
                }
            }
            arrive() {
                if (this.target.owner === this.playerId) {
                    this.target.stationedUnits[this.type]++;
                } else {
                    if (this.type === 'soldier') {
                        this.target.hp -= this.damage;
                        if (this.target.hp <= 0) {
                            this.target.owner = -1; this.target.hp = 0; this.target.buildings = []; 
                            this.target.usedSlots = 0; this.target.type = 'neutral';
                            this.target.stationedUnits = { soldier: 0, colony: 0 };
                        }
                    } else if (this.type === 'colony') {
                        if (this.target.owner === -1) {
                            this.target.owner = this.playerId; this.target.hp = this.target.maxHp;
                            if (this.target.type === 'neutral') this.target.type = 'occupied';
                            this.target.stationedUnits[this.type]++;
                        }
                    }
                }
                this.dead = true;
            }

            draw() {
                ctx.fillStyle = COLORS[this.playerId + 1];
                ctx.beginPath();
                ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.stroke();
            }
        }

        function startGame(count) {
            playerCount = count; document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('instruction-overlay').style.display = 'block';
            gameState = 'selecting'; initMap();
            requestAnimationFrame(gameLoop);
        }
        function initMap() {
            players = []; islands = []; units = [];
            for (let i = 0; i < playerCount; i++) players.push({ id: i, gold: 400, aetherum: 150, population: 0 });
            const radius = 300 + (playerCount * 20); const centerX = window.innerWidth / 2; const centerY = window.innerHeight / 2;
            const totalIslands = playerCount * 5;
            for (let i = 0; i < totalIslands; i++) {
                const ang = Math.random() * Math.PI * 2;
                const r = 50 + Math.random() * radius; const size = 20 + Math.random() * 25;
                islands.push(new Island(centerX + Math.cos(ang) * r, centerY + Math.sin(ang) * r, size, islands.length));
            }
            resize();
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resize);

        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 1 || e.button === 2) {
                isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; return;
            }
            const rect = canvas.getBoundingClientRect();
            const sx = e.clientX - rect.left; const sy = e.clientY - rect.top;
            const mx = (sx - canvas.width / 2) / camera.zoom + canvas.width / 2 - camera.x;
            const my = (sy - canvas.height / 2) / camera.zoom + canvas.height / 2 - camera.y;
            let found = null;
            islands.forEach(isl => {
                const dx = isl.x - mx; const dy = isl.y - my;
                if (Math.sqrt(dx*dx + dy*dy) < isl.size) found = isl;
            });
            if (found && gameState === 'selecting') {
                found.owner = myPlayerId; found.type = 'palace';
                found.buildings.push('palace'); found.usedSlots += 3;
                const neutrals = islands.filter(isl => isl.owner === -1 && isl !== found);
                for(let i=1; i < playerCount; i++) {
                    const aiIsl = neutrals.splice(Math.floor(Math.random() * neutrals.length), 1)[0];
                    if(aiIsl) { aiIsl.owner = i; aiIsl.type = 'palace'; aiIsl.buildings.push('palace'); aiIsl.usedSlots += 3; }
                }
                gameState = 'playing';
                document.getElementById('instruction-overlay').style.display = 'none';
                return;
            }
            if (found) { selectedIsland = found; updateUI(); } 
            else { selectedIsland = null; updateUI(); }
        });

        const BLD_DATA = { 
            mine: {g:50, s:2, goldProd: 4}, 
            barracks: {g:100, s:2}, 
            lab: {g:150, s:2}, 
            palace: {g:0, s:3, popCap: 5, goldProd: 7, aethProd: 2},
            farm: {g:30, s:1, popCap: 2},
            windmill: {g:60, s:2, popCap: 4}
        };
        function updateUI() {
            if (!selectedIsland) { UI.bottom.classList.remove('visible'); return; }
            UI.bottom.classList.add('visible');
            UI.name.innerText = `Island #${selectedIsland.id} (${selectedIsland.type.toUpperCase()})`;
            UI.owner.innerText = selectedIsland.owner === -1 ? 'Owner: Neutral' : `Owner: Player ${selectedIsland.owner + 1}`;
            UI.hp.innerText = `HP: ${Math.floor(selectedIsland.hp)} / ${selectedIsland.maxHp}`;
            document.getElementById('island-slots').innerText = `Slots: ${selectedIsland.usedSlots} / ${selectedIsland.maxSlots}`;
            document.getElementById('island-units').innerText = `Units: S:${selectedIsland.stationedUnits.soldier} C:${selectedIsland.stationedUnits.colony}`;
            const bldList = document.getElementById('island-buildings'); bldList.innerHTML = '';
            if (selectedIsland.owner === myPlayerId) {
                const counts = selectedIsland.buildings.reduce((acc, b) => { acc[b] = (acc[b] || 0) + 1; return acc; }, {});
                Object.keys(counts).forEach(type => {
                    if (type === 'palace') return;
                    const div = document.createElement('div'); div.className = 'bld-item';
                    div.innerHTML = `<span>${type}</span><button onclick="demolish('${type}')">X</button>`;
                    bldList.appendChild(div);
                });
            }
            const isMy = selectedIsland.owner === myPlayerId; const hasBar = selectedIsland.buildings.includes('barracks');
            document.getElementById('btn-mine').disabled = !isMy;
            document.getElementById('btn-farm').disabled = !isMy;
            document.getElementById('btn-windmill').disabled = !isMy;
            document.getElementById('btn-barracks').disabled = !isMy; 
            document.getElementById('btn-research').disabled = !isMy;
            document.getElementById('btn-unit-train').disabled = !isMy || !hasBar;
            document.getElementById('btn-colony-train').disabled = !isMy || !hasBar;
            document.getElementById('btn-unit-send').disabled = !isMy || selectedIsland.stationedUnits.soldier <= 0;
            document.getElementById('btn-colony-send').disabled = !isMy || selectedIsland.stationedUnits.colony <= 0;
        }
        function build(type) {
            if (!selectedIsland || selectedIsland.owner !== myPlayerId) return;
            const data = BLD_DATA[type]; const p = players[myPlayerId];
            if (p.gold >= data.g && (selectedIsland.usedSlots + data.s <= selectedIsland.maxSlots)) {
                p.gold -= data.g; selectedIsland.usedSlots += data.s; selectedIsland.buildings.push(type); updateUI();
            }
        }
        function demolish(type) {
            if (!selectedIsland || selectedIsland.owner !== myPlayerId) return;
            const idx = selectedIsland.buildings.lastIndexOf(type);
            if (idx !== -1 && type !== 'palace') {
                selectedIsland.buildings.splice(idx, 1); selectedIsland.usedSlots -= BLD_DATA[type].s; updateUI();
            }
        }
        function trainUnit(type) {
            if (!selectedIsland || selectedIsland.owner !== myPlayerId) return;
            const costs = { soldier: 20, colony: 100 };
            if (players[myPlayerId].gold >= costs[type]) {
                players[myPlayerId].gold -= costs[type]; selectedIsland.stationedUnits[type]++; updateUI();
            }
        }
        function sendUnit(type) {
            if (!selectedIsland || selectedIsland.owner !== myPlayerId || selectedIsland.stationedUnits[type] <= 0) return;
            canvas.style.cursor = 'crosshair';
            const onTarget = (e) => {
                const rect = canvas.getBoundingClientRect();
                const sx = e.clientX - rect.left; const sy = e.clientY - rect.top;
                const mx = (sx - canvas.width / 2) / camera.zoom + canvas.width / 2 - camera.x;
                const my = (sy - canvas.height / 2) / camera.zoom + canvas.height / 2 - camera.y;
                islands.forEach(isl => {
                    const dx = isl.x - mx; const dy = isl.y - my;
                    if (Math.sqrt(dx*dx + dy*dy) < isl.size && isl !== selectedIsland) {
                        selectedIsland.stationedUnits[type]--;
                        units.push(new Unit(myPlayerId, selectedIsland.x, selectedIsland.y, isl, type));
                        updateUI();
                    }
                });
                canvas.style.cursor = 'default'; canvas.removeEventListener('click', onTarget);
            };
            setTimeout(() => canvas.addEventListener('click', onTarget), 10);
        }

        function aiLogic(dt) {
            players.forEach(p => {
                if (p.id === myPlayerId) return;
                const pIslands = islands.filter(isl => isl.owner === p.id);
                if (pIslands.length === 0) return;
                pIslands.forEach(isl => {
                    const types = ['mine', 'barracks', 'lab', 'farm', 'windmill'];
                    const t = types[Math.floor(Math.random() * types.length)];
                    const data = BLD_DATA[t];
                    if (p.gold >= data.g && (isl.usedSlots + data.s <= isl.maxSlots) && Math.random() < 0.005) {
                        isl.buildings.push(t); isl.usedSlots += data.s; p.gold -= data.g;
                    }
                    if (p.gold > 120 && isl.buildings.includes('barracks') && Math.random() < 0.005) {
                        const targets = islands.filter(i => i.owner === -1);
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        if (target) { units.push(new Unit(p.id, isl.x, isl.y, target, 'colony')); p.gold -= 100; }
                    }
                    if (p.gold > 40 && isl.buildings.includes('barracks') && Math.random() < 0.01) {
                        const targets = islands.filter(i => i.owner !== p.id && i.owner !== -1);
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        if (target) { units.push(new Unit(p.id, isl.x, isl.y, target, 'soldier')); p.gold -= 20; }
                    }
                });
            });
        }

        function gameLoop(timestamp) {
            const dt = timestamp - lastTime;
            lastTime = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background "stars"
            ctx.fillStyle = '#111';
            for(let i=0; i<50; i++) ctx.fillRect((i*137)%canvas.width, (i*243)%canvas.height, 2, 2);

            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-canvas.width / 2 + camera.x, -canvas.height / 2 + camera.y);

            islands.forEach(isl => {
                isl.update(dt);
                isl.draw();
            });

            units.forEach((u, i) => {
                u.update(dt);
                u.draw();
                if (u.dead) units.splice(i, 1);
            });
            ctx.restore();

            if (gameState === 'playing') {
                processResources(dt);
                aiLogic(dt);
                updateStats();
                checkWinCondition();
            }

            requestAnimationFrame(gameLoop);
        }

        function processResources(dt) {
            cycleTimer += dt;
            const isCycle = cycleTimer >= CYCLE_DURATION;
            players.forEach(p => {
                let totalCap = 0; let goldIncome = 0; let aethIncome = 0;
                islands.filter(isl => isl.owner === p.id).forEach(isl => {
                    isl.buildings.forEach(b => {
                        const d = BLD_DATA[b];
                        if (d.popCap) totalCap += d.popCap; if (d.goldProd) goldIncome += d.goldProd; if (d.aethProd) aethIncome += d.aethProd;
                    });
                });
                if (isCycle) {
                    p.gold += goldIncome; p.aetherum += aethIncome;
                }
                const rate = 0.05; const pop = p.population;
                if (pop < totalCap) p.population += totalCap * rate * (dt / 1000);
                else if (pop < totalCap + 2) p.population += (totalCap * rate * (dt / 1000)) / 10;
                else if (pop >= totalCap + 3) p.population -= (pop - (totalCap + 2)) * rate * (dt / 1000);
            });
            if (isCycle) cycleTimer -= CYCLE_DURATION;
        }

        function updateStats() {
            UI.gold.innerText = Math.floor(players[myPlayerId].gold);
            UI.aeth.innerText = Math.floor(players[myPlayerId].aetherum);
            UI.pop.innerText = Math.floor(players[myPlayerId].population);
            document.getElementById('island-count').innerText = islands.filter(i => i.owner === myPlayerId).length;
            document.getElementById('unit-count').innerText = units.filter(u => u.playerId === myPlayerId).length;
            const time = Math.floor(lastTime / 1000);
            const m = Math.floor(time / 60).toString().padStart(2, '0');
            const s = (time % 60).toString().padStart(2, '0');
            document.getElementById('game-time').innerText = `${m}:${s}`;
            if (selectedIsland) updateUI();
        }

        function checkWinCondition() {
            const palaces = islands.filter(i => i.type === 'palace');
            const owners = [...new Set(palaces.map(p => p.owner))];
            
            if (owners.length === 1) {
                gameState = 'finished';
                document.getElementById('victory-screen').style.display = 'flex';
                document.getElementById('win-text').innerText = owners[0] === myPlayerId ? "VICTORY" : "DEFEAT";
                document.getElementById('win-text').style.color = COLORS[owners[0] + 1];
            }
        }
    </script>
</body>
</html>